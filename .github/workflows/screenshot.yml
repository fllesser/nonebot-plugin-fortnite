name: Daily Screenshot

on:
  # schedule:
  #   # 每天 UTC 0:02 运行 (北京时间 8:02)
  #   - cron: 0 0 * * *
  workflow_dispatch: # 允许手动触发

jobs:
  screenshot:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      TZ: "Asia/Shanghai"
      LOCALSTORE_USE_CWD: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install uv and set the python version
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: "3.13"
          version: "latest"

      - name: Install dependencies
        run: uv sync --locked

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
            ~/work/nonebot-plugin-fortnite/nonebot-plugin-fortnite/data/nonebot_plugin_htmlrender
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/uv.lock') }}
          restore-keys: ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: uv run playwright install chromium-headless-shell --with-deps

      - name: Run screenshot script
        run: uv run scripts/screenshot.py

      - name: Upload screenshots to branch
        run: |
          # 配置 git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 删除远程 screenshots 分支（如果存在）
          git push origin --delete screenshots 2>/dev/null || true

          # 创建新的孤立分支
          git checkout --orphan screenshots

          # 清空工作区
          git rm -rf . 2>/dev/null || true

          # 复制新截图
          cp data/nonebot_plugin_fortnite/*.png ./ 2>/dev/null || true

          # 添加 README
          cat > README.md << 'EOF'
          # 堡垒之夜每日截图

          本分支存储每日自动生成的截图。

          - **商城截图**: `shop.png`
          - **VB图截图**: `vb.png`

          # 提交并推送
          git add SHOP-*.png VB-*.png README.md
          git commit -m "Update screenshots - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          git push -f origin screenshots
